<h1>ExecutorCompletionService in practice</h1>


`ExecutorCompletionService` wrapper class tries to address one of the biggest 
deficiencies of `Future&lt;T&gt;` type - no support for callbacks or any 
event-driven behaviour whatsoever.  Let's go back for a moment to our 
sample asynchronous task downloading contents of a given URL:

<div><div id="highlighter_162778" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">final</code> <code class="java plain">ExecutorService pool = Executors.newFixedThreadPool(</code><code class="java value">10</code><code class="java plain">);</code></div><div class="line number2 index1 alt1"><code class="java plain">pool.submit(</code><code class="java keyword">new</code> <code class="java plain">Callable&lt;String&gt;() {</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String call() </code><code class="java keyword">throws</code> <code class="java plain">Exception {</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">(InputStream input = url.openStream()) {</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">IOUtils.toString(input, StandardCharsets.UTF_8);</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number9 index8 alt2"><code class="java plain">});</code></div></div></td></tr></tbody></table></div></div>

Having such code we can easily write a simple web search engine/crawler, 
examining several URLs concurrently:

<div><div id="highlighter_446151" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">final</code> <code class="java plain">List&lt;String&gt; topSites = Arrays.asList(</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"www.google.com"</code><code class="java plain">, </code><code class="java string">"www.youtube.com"</code><code class="java plain">, </code><code class="java string">"www.yahoo.com"</code><code class="java plain">, </code><code class="java string">"www.msn.com"</code><code class="java plain">,</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"www.wikipedia.org"</code><code class="java plain">, </code><code class="java string">"www.baidu.com"</code><code class="java plain">, </code><code class="java string">"www.microsoft.com"</code><code class="java plain">, </code><code class="java string">"www.qq.com"</code><code class="java plain">,</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"www.bing.com"</code><code class="java plain">, </code><code class="java string">"www.ask.com"</code><code class="java plain">, </code><code class="java string">"www.adobe.com"</code><code class="java plain">, </code><code class="java string">"www.taobao.com"</code><code class="java plain">,</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"www.youku.com"</code><code class="java plain">, </code><code class="java string">"www.soso.com"</code><code class="java plain">, </code><code class="java string">"www.wordpress.com"</code><code class="java plain">, </code><code class="java string">"www.sohu.com"</code><code class="java plain">,</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"www.windows.com"</code><code class="java plain">, </code><code class="java string">"www.163.com"</code><code class="java plain">, </code><code class="java string">"www.tudou.com"</code><code class="java plain">, </code><code class="java string">"www.amazon.com"</code></div><div class="line number7 index6 alt2"><code class="java plain">);</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="java keyword">final</code> <code class="java plain">ExecutorService pool = Executors.newFixedThreadPool(</code><code class="java value">5</code><code class="java plain">);</code></div><div class="line number10 index9 alt1"><code class="java plain">List&lt;Future&lt;String&gt;&gt; contentsFutures = </code><code class="java keyword">new</code> <code class="java plain">ArrayList&lt;&gt;(topSites.size());</code></div><div class="line number11 index10 alt2"><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">final</code> <code class="java plain">String site : topSites) {</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Future&lt;String&gt; contentFuture = pool.submit(</code><code class="java keyword">new</code> <code class="java plain">Callable&lt;String&gt;() {</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String call() </code><code class="java keyword">throws</code> <code class="java plain">Exception {</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">IOUtils.toString(</code><code class="java keyword">new</code> <code class="java plain">URL(</code><code class="java string">"<a href="http://">http://</a>"</code> <code class="java plain">+ site), StandardCharsets.UTF_8);</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">});</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">contentsFutures.add(contentFuture);</code></div><div class="line number19 index18 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

As easy as that. We simply submit separate task for each web site to a pool and wait for results. To achieve that we collect all <code>Future&lt;String&gt;</code> objects into a collection and iterate through them:<br>

<div><div id="highlighter_297194" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">for</code> <code class="java plain">(Future&lt;String&gt; contentFuture : contentsFutures) {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">String content = contentFuture.get();</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">//...process contents</code></div><div class="line number4 index3 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

Each call to <code>contentFuture.get()</code> waits until downloading given web site (remember that each <code>Future</code> represent one site) is finished. This works, but has a major bottleneck. Imagine you have as many threads in a pool as tasks (20 sites in that case). I think it's understandable that you want to start processing contents of web sites as soon as they arrive, no matter which one is first. Response times vary greatly so don't be surprised to find some web sites responding within a second while others need even 20 seconds. But here's the problem: after submitting all the tasks we block on an arbitrary <code>Future&lt;T&gt;</code>. There is no guarantee that this <code>Future</code> will complete first. It is very likely that other <code>Future</code> objects already completed and are ready for processing but we keep hanging on that arbitrary, first <code>Future</code>. In worst case scenario, if the first submitted page is slower by an order of magnitude compared to all the others, all the results except the first one are ready for processing and idle, while we keep waiting for the first one.<br>

The obvious solution would be to sort web sites from fastest to slowest and submit them in that order. Then we would be guaranteed that <code>Future</code>s complete in the order in which we submitted them. But this is impractical and almost impossible in real life due to dynamic nature of web.<br>

This is where <code>ExecutorCompletionService</code> steps in. It is a thin wrapper around <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a> that "remembers" all submitted tasks and allows you to wait for the first <i>completed</i>, as opposed to first <i>submitted</i> task. In a way <code>ExecutorCompletionService</code> keeps a handle to all intermediate <code>Future</code> objects and once any of them finishes, it's returned. Crucial API method is <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CompletionService.html#take()"><code>CompletionService.take()</code></a> that blocks and waits for <i>any</i> underlying <code>Future</code> to complete. Here is the submit step with <code>ExecutorCompletionService</code>:<br>

<div><div id="highlighter_497755" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">final</code> <code class="java plain">ExecutorService pool = Executors.newFixedThreadPool(</code><code class="java value">5</code><code class="java plain">);</code></div><div class="line number2 index1 alt1"><code class="java keyword">final</code> <code class="java plain">ExecutorCompletionService&lt;String&gt; completionService = </code><code class="java keyword">new</code> <code class="java plain">ExecutorCompletionService&lt;&gt;(pool);</code></div><div class="line number3 index2 alt2"><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">final</code> <code class="java plain">String site : topSites) {</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">completionService.submit(</code><code class="java keyword">new</code> <code class="java plain">Callable&lt;String&gt;() {</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">String call() </code><code class="java keyword">throws</code> <code class="java plain">Exception {</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">IOUtils.toString(</code><code class="java keyword">new</code> <code class="java plain">URL(</code><code class="java string">"<a href="http://">http://</a>"</code> <code class="java plain">+ site), StandardCharsets.UTF_8);</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">});</code></div><div class="line number10 index9 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

Notice how we seamlessly switched to <code>completionService</code>. Now the retrieval step:<br>

<div><div id="highlighter_316939" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">for</code><code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code><code class="java plain">; i &lt; topSites.size(); ++i) {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Future&lt;String&gt; future = completionService.take();</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">String content = future.get();</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">//...process contents</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">catch</code> <code class="java plain">(ExecutionException e) {</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">log.warn(</code><code class="java string">"Error while downloading"</code><code class="java plain">, e.getCause());</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number9 index8 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

You might be wondering why we need an extra counter? Unfortunately <code>ExecutorCompletionService</code> doesn't tell you how many <code>Future</code> objects are still there waiting so you must remember how many times to call <code>take()</code>.<br>

This solution feels much more robust. We process responses immediately when they are ready. <code>take()</code> blocks until fastest task still running finishes. And if processing takes a little bit longer and multiple responses finished, subsequent call to <code>take()</code> will return immediately. It's fun to observe the program when number of pool threads is as big as the number of tasks so that we begin downloading each site at the same time. You can easily see which websites have shortest response time and which respond very slowly.<br>

<hr>

`ExecutorCompletionService` seems wonderful, but in fact it is quite limited. 
You cannot use it with arbitrary collection of `Future` objects which you 
happened to obtain somehow. It works only with `Executor` abstraction. 
Also there is no built in support for processing incoming results concurrently 
as well. If we want to parse results concurrently, we need to manually submit 
them to a second thread pool. In the next few articles I will show you more 
powerful constructs that mitigate these disadvantages.



